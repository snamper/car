<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>完善基本资料</title>
    <link href="../../css/mui.min.css" rel="stylesheet"/>
    <link href="../../css/mui.picker.all.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8"/>
</head>
<style>
	.sw-gou{
		height:12px;width:12px;background: url(../../image/login/icon_gou.png) no-repeat;background-size: contain;display: inline-block;vertical-align: middle;margin-right: 4px;
	}
	.sw-quan{
		height:12px;width:12px;background: url(../../image/login/icon_quan.png) no-repeat;background-size: contain;display: inline-block;vertical-align: middle;margin-right: 4px;
	}
	.sw-list-title{
		font-size: 14px;
	}
	.sw-list-title1{
		font-size: 14px;width: 70px;display: inline-block;color: #333;
	}
	.sw-list-text1{
		font-size: 12px;margin-left: 12px;color: #666;
	}
	.sw-list-text2{		
		margin-right: 16px;
	    font-size: 12px;
	    color: #666;
	    position: relative;
	    text-align: right;
	    display: block;
	    margin-top: -21px; 
	    overflow: hidden;
	    margin-left: 78px; 
	    white-space: nowrap;
	    text-overflow: ellipsis;
	}
	.sw-list-text3{
		padding-right:16px;font-size: 12px;color: #666;
	}
	.sw-list-input1{
		border: none;height: 21px;font-size:12px;padding-left: 12px;width: 60%;
	}
	.sw-list-input2{
		border: none;height: 21px;font-size:12px;width: 60%;
	}
	
	.sw-no-active,.sw-no-active:active{
		background: #FFFFFF!important;
	} 
	.sw-after-r:after{
		margin-right: 15px;
	}
	.sw-after-no:after{
		height: 0;
	}
	.sw-map-box{
		width: 220px;height: 120px;float: right;margin-top: 12px;border: 1px solid #EFEFEF;font-size: 12px;color: #999999;text-align: center;line-height: 120px;border-radius: 2px;
	}
	.sw-major{
		border: none;font-size: 12px;overflow-y: hidden;padding: 0;margin-bottom: 0;
	}
	.sw-address{
		border: none;font-size: 12px;overflow-y: hidden;padding: 0;margin-bottom: 0;
	}
	input,textarea{
		user-select: text!important;
	}
</style>
<body style="background: #F5f5f5;" onload="startInputData()">
	<header class="mui-bar mui-bar-nav">
	    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	    <h1 class="mui-title">完善基本资料</h1>
	</header>
	
	<div style="width: 100%;margin-top: 45px;margin-bottom: 55px;">
		
		<ul class="mui-table-view" style="margin-top: -1px;">
			
			<li class="mui-table-view-cell sw-no-active">
			 	<span class="sw-ctheme sw-list-title">企业类型：</span>
			 	<span class="sw-list-text1 firmType1" onclick="selectFirmType(this)">
			 		<label for="firmType1">
			 			<p class="sw-gou firmType"></p>经销商
			 			<input type="radio" name="firmType" checked="checked" id="firmType1" value="1" hidden="hidden" />
			 		</label>			 		
			 	</span>
			 	<span class="sw-list-text1 firmType2" onclick="selectFirmType(this)">
			 		<label for="firmType2">
			 			<p class="sw-quan firmType"></p>汽修厂
			 			<input type="radio" name="firmType" id="firmType2" value="2" hidden="hidden" />
			 		</label>
			 		
			 	</span>
			 </li>
			
			<li class="mui-table-view-cell  sw-no-active sw-after-r sw-fenlei sw-fenlei1" style="display: block;">
			 	<span class="sw-ctheme sw-list-title">企业分类：</span>
			 	<span class="sw-list-text1 classT1" onclick="selectClass(this)">
			 		<label for="jx1">
				 		<p class="sw-gou firmClass firmClassDef"></p>轿车商家
				 		<input type="radio" name="jxType" id="jx1" value="1" checked="checked" hidden="hidden"/>
			 		</label>	
			 	</span>
			 	<span class="sw-list-text1 classT2" onclick="selectClass(this)">
			 		<label for="jx2">
				 		<p class="sw-quan firmClass"></p>货车商家
				 		<input type="radio" name="jxType" id="jx2" value="2" hidden="hidden"/>
				 	</label>
			 	</span>
			 	<span class="sw-list-text1 classT3" onclick="selectClass(this)">
			 		<label for="jx3">
				 		<p class="sw-quan firmClass"></p>用品商家
				 		<input type="radio" name="jxType" id="jx3" value="3" hidden="hidden"/>
				 	</label>
			 	</span>
			 </li>
			
			 <li class="mui-table-view-cell  sw-no-active sw-after-r sw-fenlei sw-fenlei2" style="display: none;">
			 	<span class="sw-ctheme sw-list-title">企业分类：</span> 
			 	<span class="sw-list-text1 classT4" onclick="selectClass(this)">
			 		<label for="qx4">
				 		<p class="sw-gou firmClass firmClassDef"></p>修理厂
				 		<input type="radio" name="qxType" id="qx4" value="4" hidden="hidden"/>
				 	</label>	
			 	</span>
			 	<span class="sw-list-text1 classT5" onclick="selectClass(this)">
			 		<label for="qx5">
				 		<p class="sw-quan firmClass"></p>快修保养
				 		<input type="radio" name="qxType" id="qx5" value="5" hidden="hidden"/>
			 		</label>	
			 	</span>
			 	<span class="sw-list-text1 classT6" onclick="selectClass(this)">
			 		<label for="qx6">
				 		<p class="sw-quan firmClass"></p>美容店
				 		<input type="radio" name="qxType" id="qx6" value="6" hidden="hidden"/> 
			 		</label>	
			 	</span>
			 </li>
			
			
			
			<li class="mui-table-view-cell sw-after-r" id="scope">
				<a class="mui-navigate-right">
					<span class="sw-ctheme sw-list-title">经营范围：</span>
					<span class="sw-list-text2" id="scopeText">请选择经营范围</span>
					<input type="text" name="business" id="business" value="" hidden="hidden"/>
				</a>
			</li>
			
			 <li class="mui-table-view-cell  sw-no-active sw-after-r">
			 	<span class="sw-ctheme sw-list-title">企业名称：</span>
			 	<input class="sw-list-input1" name="companyname" id="companyname" placeholder="请输入企业名称"/>
			 </li>
			
			<li class="mui-table-view-cell sw-after-r" id="showCityPicker">
				<a class="mui-navigate-right">
					<span class="sw-ctheme sw-list-title">所属地区：</span>
					<span class="sw-list-text2" id="cityStr">请选择所属地区</span>
					<input type="text" name="province"  id="province" value="" hidden="hidden"/>
					<input type="text" name="city" 		id="city" value="" hidden="hidden"/>
					<input type="text" name="district"  id="district" value="" hidden="hidden"/>					
				</a>
			</li>
			 
			 <li class="mui-table-view-cell sw-no-active sw-after-r"> 
					<a class="mui-navigate-right sw-no-active">
						<span class="sw-ctheme sw-list-title">企业坐标：</span>
						<span class="sw-list-text2" id="mapText">&nbsp;</span> 
					</a>
					<input type="text" name="longitude" id="longitude" value=""  hidden="hidden"/>
					<input type="text" name="latitude"  id="latitude"  value=""  hidden="hidden"/>					
					<div id="allmap" class="sw-map-box">地图加载中...</div>
			</li>
			 
			 <li class="mui-table-view-cell sw-no-active sw-after-r"> 
				<span class="sw-ctheme sw-list-title">详细地址：</span>
			 	<div style="margin-left: 87px;margin-top: -22px;font-size: 12px;color: #999999;">
			 		<textarea class="sw-address" name="address" id="address" placeholder="坐标地址不计入详细地址中，需再手动填写"></textarea>
			 	</div>
			</li>
			 
		</ul> 
		
		
		<ul class="mui-table-view" style="margin-top:10px;">
			
			 <li class="mui-table-view-cell sw-after-no">
					<a class="mui-navigate-right" id="uploadImg">
						<span class="sw-list-title1" style="line-height: 60px;">封面</span>
						<img src="../../image/person/purchase/tianjiazp.png" id="faceImg" style="width: 60px;height: 60px;float: right;margin-right: 20px;"/>
						<input id="face_img" name="face_img" value="" hidden="hidden"/>
					</a>
			</li>
			
			 <li class="mui-table-view-cell sw-no-active sw-after-no">
			 	<span class="sw-list-title1">主营</span>
			 	<div style="margin-left: 75px;margin-top: -22px;font-size: 12px;color: #999999;">
			 		<textarea class="sw-major" id="major" name="major" placeholder="请输入主营描述"></textarea>
			 	</div>
			 </li>
			
			 <li class="mui-table-view-cell  sw-no-active sw-after-no">
			 	<span class="sw-list-title1">联系人</span>
			 	<input class="sw-list-input2" id="linkMan" name="linkMan" placeholder="请输入联系人名称"/>
			 </li>
			
			<li class="mui-table-view-cell  sw-no-active sw-after-no"> 
			 	<span class="sw-list-title1" style="">手机</span>
			 	<input class="sw-list-input2" id="linkPhone" name="linkPhone" placeholder="请输入联系人手机号"/>
			 </li>
			
			 <li class="mui-table-view-cell  sw-no-active sw-after-no">
			 	<span class="sw-list-title1" style="">座机</span>
			 	<input class="sw-list-input2" id="linkTel" name="linkTel" placeholder="请输入座机号码"/>  
			 </li>
			
			  <li class="mui-table-view-cell  sw-no-active sw-after-no">
			 	<span class="sw-list-title1" style="">QQ</span>
			 	<input class="sw-list-input2" id="linkQQ" name="linkQQ" placeholder="请输入QQ号码"/>
			 </li>
		</ul>
		
		
		 <div style="width: 100%;padding: 0 8%;margin-top: 55px;">
		 	<button type="button" class="mui-btn mui-btn-tangerine mui-btn-block" onclick="saveMaterial()">提交</button>
		 </div>
		
	</div>
	
</body>
<script src="../../js/mui.min.js"></script>
<script src="../../js/global.js"></script>
<script src="../../js/mui.picker.js"></script>
<script src="../../js/mui.poppicker.js"></script>
<script src="../../js/city.data-3.js"></script>
 <script src="../../js/jquery.min.js"></script>
 <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ZBcSIHdvwjfx105K8jvQCj5W"></script> 
<script>
	//mui初始化

	var	firmsId = '';
	// 百度地图API功能
	var map = new BMap.Map("allmap");

	//mui plusReady
	$(function() {
		
		var self  = sw.getQueryVariable();
		    firmsId = self.firmsId;	
			sw.jcon(firmsId);

		//延时加载地图
		setTimeout(function(){

			var geolocation = new BMap.Geolocation();
			geolocation.getCurrentPosition(function(r){
				if(this.getStatus() == BMAP_STATUS_SUCCESS){

					//重设地图坐标
					setMap(r.point);
				}
				else {
					sw.toast('failed'+this.getStatus());
				}
			},{enableHighAccuracy: true});

			
			//初始化城市选择
			var cityPicker = new mui.PopPicker({
					layer: 3,
					title:'选择城市',
					value:'山西省 太原市 小店区'
			});
			cityPicker.setData(cityData3);
			
			var showCityPickerButton = document.getElementById('showCityPicker');
			
			document.getElementById('showCityPicker').addEventListener('tap', function(event) {
				cityPicker.show(function(items) {
					var province = (items[0] || {}).text;
					var city     = (items[1] || {}).text;
					var district = (items[2] || {}).text;
					
					province = province?province:'';
					city     = city?city:'';
					district = district?district:'';
					
					$("#province").val(province);
					$("#city").val(city);			
					$("#district").val(district);
								
					var cityStr = province+ " " + city+ " " + district;
					$("#cityStr").text(cityStr);
				});
			}, false);
					
		},300)
				
	})
	
	//百度地图调用
	function setMap(point){      	 	 	
			// 百度地图API功能
			var map = new BMap.Map("allmap"); 
				map.centerAndZoom(point, 15);
			
			var marker = new BMap.Marker(point);// 创建标注 
				map.addOverlay(marker); 				
				marker.enableDragging();//允许拖拽
				
				var geoc = new BMap.Geocoder();//获取定位信息			
				getLatLngAdd(geoc,point);	 							
				//拖拽结束事件
				marker.addEventListener("dragend", function(e){
					var o_Point_now =  marker.getPosition();
						getLatLngAdd(geoc,o_Point_now); 
				})	 
	}
	
	/**
	 * 根据地址获取中文
	 */
	function getLatLngAdd(geoc,point){		
		geoc.getLocation(point, function(rs){
						var addComp = rs.addressComponents;
						var address = addComp.district+	addComp.street+addComp.streetNumber;
						$("#mapText").text(address);
						//将坐标保存
						$("#latitude").val(point.lat);
						$("#longitude").val(point.lng);
				}); 					
	}
		
	/**
	 *选择经销商类型 
	 */
	function selectFirmType(j){
		//移除样式
		$(".firmType").removeClass('sw-gou').addClass('sw-quan');
		//对应下面增加样式
		$(j).find('.firmType').addClass('sw-gou').removeClass('sw-quan');
		//获取选择的经销商类型
		var typeName = $('input[name="firmType"]:checked').val();
		//修改企业分类
		var fenleiClass = ".sw-fenlei"+typeName;
		$(".sw-fenlei").hide();
		$(fenleiClass).show();
		//初始化分类选项
		$(".firmClass").removeClass('sw-gou').addClass('sw-quan');
		$(".firmClassDef").removeClass('sw-quan').addClass('sw-gou');
		if(typeName==1){
			$("#scope").show();
		}else{
			$("#scope").hide();
		}
	}
	
	/**
	 * 选择经销商分类
	 * @param {Object} j
	 */
	function selectClass(j){
		var buss = $(j).find('input').val();
		if($(j).find('.firmClass').hasClass('sw-gou')==false){
			$("#scopeText").text('请选择经营范围');
			$("#business").val('');	
		}
		//移除样式
		$(".firmClass").removeClass('sw-gou').addClass('sw-quan');
		//对应下面增加样式
		$(j).find('.firmClass').addClass('sw-gou').removeClass('sw-quan');		
	}
	
	
	/**
	 * 保存提交数据
	 */
	function saveMaterial(){ 		

        var companyType = $('input[name="firmType"]:checked').val();
        //console.log(companyType);
        if(companyType==1){
            var classification = $('input[name="jxType"]:checked').val();
        }else {
            var classification = $('input[name="qxType"]:checked').val(); 
        }
        //console.log(classification);
        var business    = $('input[name="business"]').val();   //经营范围
        var companyname = $('input[name="companyname"]').val();//企业名称
        var province    = $('#province').val();
        var city        = $('#city').val();
        var district    = $('#district').val();
        var address     = $('textarea[name="address"]').val();
        var coordinate  = $('#mapText').text();
        //经纬度
        var longitude   = $('input[name="longitude"]').val();
        var latitude    = $('input[name="latitude"]').val();
        var face_pic    = $('input[name="face_img"]').val();//封面
        var major       = $('textarea[name="major"]').val();//主营
        var linkMan     = $('input[name="linkMan"]').val(); //联系人
        var linkPhone   = $('input[name="linkPhone"]').val();//手机
        var linkTel     = $('input[name="linkTel"]').val();//座机
        var qq          = $('input[name="linkQQ"]').val();//QQ
        //console.log(business);

        var postData = {
        		   'firmsId':firmsId,
               'companyType':companyType,
            'classification':classification,
                  'business':business,
               'companyname':companyname,
                  'province':province,
                      'city':city,
                  'district':district,
                   'address':address,
                'coordinate':coordinate,
                 'longitude':longitude,
                  'latitude':latitude,
                  'face_pic':face_pic,
                     'major':major,
                   'linkMan':linkMan,
                 'linkPhone':linkPhone,
                   'linkTel':linkTel,
                        'qq':qq
        };
        
        //保存材料信息
        http.load('api.sev.register','saveMaterial',postData,function(rData){//请求成功
        	
        	sw.toast(rData.msg);          	
        	if(rData.status==200){  		      		
				onSuccess(rData);
				//
                openView('../../view/person/index.html','person_index','pop-in');
			}
        },function(xhr,type,errorThrown){//请求失败 将之前的数据填入		
				//无网络提示
				sw.toast('请求失败，请检查网络'); 
		})
          
	}


	//经营范围  根据轿车 货车 物流 分别获取 
	mui("#scope")[0].addEventListener('tap',function(){
	    //保存数据
        saveInputData();

        var firmClass = $("input[name='jxType']:checked").val();
		var data = {'firmClass':firmClass};
		openView('../../view/register/scope.html','scope','pop-in',data);
	});
	
	//选择图片
	mui("#uploadImg")[0].addEventListener('tap',function(){		
		openView('../../view/common/uploadImg.html','uploadImg','pop-in');
	})

    /**
	 * 将数据保存到本地
     */
	function  saveInputData() {
        var companyType = $('input[name="firmType"]:checked').val();
        //console.log(companyType);
        if(companyType==1){
            var classification = $('input[name="jxType"]:checked').val();
        }else {
            var classification = $('input[name="qxType"]:checked').val();
        }
        //console.log(classification);
        var business    = $('input[name="business"]').val();   //经营范围
        var companyname = $('input[name="companyname"]').val();//企业名称
        var province    = $('#province').val();
        var city        = $('#city').val();
        var district    = $('#district').val();
        var address     = $('textarea[name="address"]').val();
        var coordinate  = $('#mapText').text();
        //经纬度
        var longitude   = $('input[name="longitude"]').val();
        var latitude    = $('input[name="latitude"]').val();
        var face_pic    = $('input[name="face_img"]').val();//封面
        var major       = $('textarea[name="major"]').val();//主营
        var linkMan     = $('input[name="linkMan"]').val(); //联系人
        var linkPhone   = $('input[name="linkPhone"]').val();//手机
        var linkTel     = $('input[name="linkTel"]').val();//座机
        var qq          = $('input[name="linkQQ"]').val();//QQ
        //console.log(business);

        var postData = {
            'firmsId':firmsId,
            'companyType':companyType,
            'classification':classification,
            'business':business,
            'companyname':companyname,
            'province':province,
            'city':city,
            'district':district,
            'address':address,
            'coordinate':coordinate,
            'longitude':longitude,
            'latitude':latitude,
            'face_pic':face_pic,
            'major':major,
            'linkMan':linkMan,
            'linkPhone':linkPhone,
            'linkTel':linkTel,
            'qq':qq
        };

        JsonStorage.setItem('materialData',JSON.stringify(postData));
    }

    /**
	 * 将保存的数据输出
     */
    function startInputData() {

        if(JsonStorage.getItem('materialData')&&JsonStorage.getItem('materialData')!=''){
            var data = JSON.parse(JsonStorage.getItem('materialData'));

			var firmTypeObj = $(".classT"+data.classification);
            selectClass(firmTypeObj);

            $('input[name="business"]').val(data.business);   //经营范围
            $('input[name="companyname"]').val(data.companyname);//企业名称

            var province = data.province;
            var city = data.city;
            var district = data.district;

            var cityStr = province+ " " + city+ " " + district;

            $("#cityStr").text(cityStr);

            $('#province').val(province);
            $('#city').val(city);
            $('#district').val(district);

            $('textarea[name="address"]').val(data.address);
            $('#mapText').text(data.coordinate);
            //经纬度
            $('input[name="longitude"]').val(data.longitude);
            $('input[name="latitude"]').val(data.latitude);
            $('input[name="face_img"]').val(data.face_img);//封面
            $('textarea[name="major"]').val(data.major);//主营
            $('input[name="linkMan"]').val(data.linkMan); //联系人
            $('input[name="linkPhone"]').val(data.linkPhone);//手机
            $('input[name="linkTel"]').val(data.linkTel);//座机
            $('input[name="linkQQ"]').val(data.qq);//QQ
		}


        var pIIIs = JsonStorage.getItem('pIIIs');
        if(pIIIs==1){
            var firmClasses = JSON.parse(JsonStorage.getItem('firmClasses'));
            var classLen = firmClasses.length;
            var str   = '';
            var business = ',';
            for(var i=0;i<classLen;i++){
                var firm = firmClasses[i].split(",");
                str += " "+firm[1];
                business += firm[0]+',';
            }

            $("#scopeText").text(str);
            $("#business").val(business);

        }


        var pIImg = JsonStorage.getItem('pIImg');
        if(pIImg==1){
            var face_pic = JsonStorage.getItem('face_pic');
            var faceImg  =	imgUrl + face_pic;
            $("#faceImg").attr('src',faceImg);
            $("#face_img").val(faceImg);

        }

    }
 </script>

</html>